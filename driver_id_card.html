<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver ID Card - Camera Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: #f0f2f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #3498db;
        }
        
        .photo-section {
            text-align: center;
            margin: 25px 0;
        }
        
        .photo-container {
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            border-radius: 50%;
            border: 3px dashed #3498db;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        
        .photo-container:hover {
            border-color: #2980b9;
            background: #f0f7ff;
        }
        
        #photoPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .photo-placeholder {
            color: #7f8c8d;
            text-align: center;
        }
        
        .camera-icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: bold;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .hidden {
            display: none;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .success {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .error {
            background: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .info {
            background: #d6eaf8;
            color: #2980b9;
            border: 1px solid #3498db;
        }
        
        .photo-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .photo-btn {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .photo-btn:hover {
            background: #2980b9;
        }
        
        /* Camera Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
        }
        
        #cameraVideo {
            width: 100%;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* Preview Section */
        .preview-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .card-preview {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin: 20px auto;
            max-width: 350px;
        }
        
        .card-photo {
            width: 100px;
            height: 120px;
            border-radius: 5px;
            border: 2px solid white;
            object-fit: cover;
            margin-bottom: 15px;
        }
        
        .card-info {
            text-align: left;
            margin-bottom: 15px;
        }
        
        .card-field {
            margin-bottom: 10px;
        }
        
        .card-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .card-value {
            font-size: 16px;
            font-weight: bold;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
                margin: 10px;
            }
            
            .photo-container {
                width: 150px;
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Driver ID Card</h1>
        
        <div id="statusMessage" class="status hidden"></div>
        
        <!-- Photo Section -->
        <div class="photo-section">
            <div class="photo-container" id="photoContainer">
                <img id="photoPreview" alt="Driver Photo">
                <div class="photo-placeholder" id="photoPlaceholder">
                    <div class="camera-icon">üì∑</div>
                    <div>Click to take photo</div>
                    <div style="font-size: 12px;">or upload from gallery</div>
                </div>
            </div>
            
            <div class="photo-actions">
                <button class="photo-btn" onclick="openCamera()">üì∏ Take Photo</button>
                <button class="photo-btn" onclick="uploadPhoto()">üìÅ Upload Photo</button>
                <button class="photo-btn" onclick="removePhoto()" style="background: #e74c3c;">üóëÔ∏è Remove</button>
            </div>
            
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
        </div>
        
        <!-- Form Section -->
        <form id="driverForm">
            <div class="form-group">
                <label for="driverId">Driver ID Number:</label>
                <input type="text" id="driverId" placeholder="Enter driver ID number" required>
            </div>
            
            <div class="form-group">
                <label for="driverName">Driver Full Name:</label>
                <input type="text" id="driverName" placeholder="Enter driver's full name" required>
            </div>
            
            <div class="form-group">
                <label for="companyName">Company Name:</label>
                <input type="text" id="companyName" placeholder="Enter company name" required>
            </div>
            
            <div class="form-group">
                <label for="expirationDate">ID Expiration Date:</label>
                <input type="date" id="expirationDate" required>
            </div>
            
            <button type="button" class="btn btn-primary" onclick="saveCard()">
                üíæ Save Card
            </button>
            
            <button type="button" class="btn btn-success" onclick="showPreview()">
                üëÅÔ∏è Preview Card
            </button>
            
            <button type="button" class="btn btn-danger" onclick="clearAll()">
                üóëÔ∏è Clear All
            </button>
        </form>
        
        <!-- Preview Section -->
        <div class="preview-section hidden" id="previewSection">
            <h2 style="color: #2c3e50; margin-bottom: 20px;">Card Preview</h2>
            
            <div class="card-preview">
                <img id="previewPhoto" class="card-photo" alt="Driver Photo">
                
                <div class="card-info">
                    <div class="card-field">
                        <div class="card-label">Driver ID:</div>
                        <div class="card-value" id="previewId">N/A</div>
                    </div>
                    <div class="card-field">
                        <div class="card-label">Name:</div>
                        <div class="card-value" id="previewName">Full Name</div>
                    </div>
                    <div class="card-field">
                        <div class="card-label">Company:</div>
                        <div class="card-value" id="previewCompany">Company Name</div>
                    </div>
                    <div class="card-field">
                        <div class="card-label">Expires:</div>
                        <div class="card-value" id="previewExpiry">2024-12-31</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="hidePreview()" style="margin-top: 20px;">
                ‚Üê Back to Edit
            </button>
        </div>
    </div>
    
    <!-- Camera Modal -->
    <div class="modal" id="cameraModal">
        <div class="modal-content">
            <h3 style="text-align: center; margin-bottom: 15px;">Take Photo</h3>
            <video id="cameraVideo" autoplay></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            
            <div class="camera-controls">
                <button class="photo-btn" onclick="capturePhoto()" style="background: #2ecc71;">
                    üì∏ Capture
                </button>
                <button class="photo-btn" onclick="closeCamera()" style="background: #e74c3c;">
                    ‚úñ Cancel
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 15px; font-size: 12px; color: #666;">
                Position your face in the frame and click Capture
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const photoContainer = document.getElementById('photoContainer');
        const photoPreview = document.getElementById('photoPreview');
        const photoPlaceholder = document.getElementById('photoPlaceholder');
        const fileInput = document.getElementById('fileInput');
        const cameraModal = document.getElementById('cameraModal');
        const cameraVideo = document.getElementById('cameraVideo');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const previewSection = document.getElementById('previewSection');
        const statusMessage = document.getElementById('statusMessage');
        
        // Form elements
        const driverId = document.getElementById('driverId');
        const driverName = document.getElementById('driverName');
        const companyName = document.getElementById('companyName');
        const expirationDate = document.getElementById('expirationDate');
        
        // Preview elements
        const previewPhoto = document.getElementById('previewPhoto');
        const previewId = document.getElementById('previewId');
        const previewName = document.getElementById('previewName');
        const previewCompany = document.getElementById('previewCompany');
        const previewExpiry = document.getElementById('previewExpiry');
        
        // Set default date (1 year from today)
        const defaultDate = new Date();
        defaultDate.setFullYear(defaultDate.getFullYear() + 1);
        expirationDate.valueAsDate = defaultDate;
        expirationDate.min = new Date().toISOString().split('T')[0];
        
        // Global variables
        let stream = null;
        let currentPhotoData = null;
        
        // Event Listeners
        photoContainer.addEventListener('click', openPhotoOptions);
        fileInput.addEventListener('change', handleFileUpload);
        
        // Load saved data on page load
        window.addEventListener('DOMContentLoaded', loadSavedData);
        
        // Show photo options
        function openPhotoOptions() {
            if (isMobile()) {
                const choice = confirm("Take photo with camera? (Cancel to choose from gallery)");
                if (choice) {
                    openCamera();
                } else {
                    uploadPhoto();
                }
            } else {
                uploadPhoto();
            }
        }
        
        // Open camera for taking photo
        function openCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment' // Use back camera on mobile
                    } 
                })
                .then(function(videoStream) {
                    stream = videoStream;
                    cameraVideo.srcObject = stream;
                    cameraModal.style.display = 'flex';
                })
                .catch(function(error) {
                    showStatus('Camera error: ' + error.message, 'error');
                    // Fallback to file upload
                    uploadPhoto();
                });
            } else {
                showStatus('Camera not supported on this device', 'error');
                uploadPhoto();
            }
        }
        
        // Close camera
        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            cameraModal.style.display = 'none';
            cameraVideo.srcObject = null;
        }
        
        // Capture photo from camera
        function capturePhoto() {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            
            // Draw current video frame to canvas
            context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
            
            // Convert to data URL
            const photoData = cameraCanvas.toDataURL('image/jpeg', 0.8);
            
            // Display the photo
            displayPhoto(photoData);
            
            // Save photo data
            currentPhotoData = photoData;
            
            // Close camera
            closeCamera();
            
            showStatus('Photo taken successfully!', 'success');
        }
        
        // Upload photo from file
        function uploadPhoto() {
            fileInput.click();
        }
        
        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if file is an image
            if (!file.type.startsWith('image/')) {
                showStatus('Please select an image file (JPEG, PNG)', 'error');
                return;
            }
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showStatus('Image too large. Max 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const photoData = e.target.result;
                displayPhoto(photoData);
                currentPhotoData = photoData;
                showStatus('Photo uploaded successfully!', 'success');
            };
            
            reader.onerror = function() {
                showStatus('Error reading file', 'error');
            };
            
            reader.readAsDataURL(file);
            
            // Reset file input
            event.target.value = '';
        }
        
        // Display photo in the container
        function displayPhoto(photoData) {
            photoPreview.src = photoData;
            photoPreview.style.display = 'block';
            photoPlaceholder.style.display = 'none';
            previewPhoto.src = photoData;
        }
        
        // Remove current photo
        function removePhoto() {
            if (confirm('Remove current photo?')) {
                photoPreview.src = '';
                photoPreview.style.display = 'none';
                photoPlaceholder.style.display = 'flex';
                previewPhoto.src = '';
                currentPhotoData = null;
                showStatus('Photo removed', 'info');
            }
        }
        
        // Save card data
        function saveCard() {
            // Validate form
            if (!validateForm()) {
                showStatus('Please fill all required fields', 'error');
                return;
            }
            
            // Prepare data
            const cardData = {
                driverId: driverId.value,
                driverName: driverName.value,
                companyName: companyName.value,
                expirationDate: expirationDate.value,
                photo: currentPhotoData,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to localStorage
            try {
                localStorage.setItem('driverCard', JSON.stringify(cardData));
                showStatus('Card saved successfully!', 'success');
                
                // Update preview
                updatePreview();
                
            } catch (error) {
                showStatus('Error saving: ' + error.message, 'error');
            }
        }
        
        // Load saved data
        function loadSavedData() {
            try {
                const savedData = localStorage.getItem('driverCard');
                if (savedData) {
                    const cardData = JSON.parse(savedData);
                    
                    // Fill form fields
                    driverId.value = cardData.driverId || '';
                    driverName.value = cardData.driverName || '';
                    companyName.value = cardData.companyName || '';
                    expirationDate.value = cardData.expirationDate || expirationDate.value;
                    
                    // Load photo if exists
                    if (cardData.photo) {
                        displayPhoto(cardData.photo);
                        currentPhotoData = cardData.photo;
                    }
                    
                    // Update preview
                    updatePreview();
                    
                    showStatus('Previous data loaded', 'info');
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Show preview
        function showPreview() {
            if (!validateForm()) {
                showStatus('Please fill all required fields first', 'error');
                return;
            }
            
            updatePreview();
            previewSection.classList.remove('hidden');
            document.getElementById('driverForm').style.display = 'none';
        }
        
        // Hide preview
        function hidePreview() {
            previewSection.classList.add('hidden');
            document.getElementById('driverForm').style.display = 'block';
        }
        
        // Update preview data
        function updatePreview() {
            previewId.textContent = driverId.value || 'N/A';
            previewName.textContent = driverName.value || 'Full Name';
            previewCompany.textContent = companyName.value || 'Company Name';
            
            if (expirationDate.value) {
                const date = new Date(expirationDate.value);
                previewExpiry.textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }
        
        // Clear all data
        function clearAll() {
            if (confirm('Clear all data? This cannot be undone.')) {
                // Clear form
                driverId.value = '';
                driverName.value = '';
                companyName.value = '';
                expirationDate.valueAsDate = defaultDate;
                
                // Clear photo
                removePhoto();
                
                // Clear localStorage
                localStorage.removeItem('driverCard');
                
                // Hide preview
                hidePreview();
                
                showStatus('All data cleared', 'info');
            }
        }
        
        // Validate form
        function validateForm() {
            return driverId.value.trim() !== '' &&
                   driverName.value.trim() !== '' &&
                   companyName.value.trim() !== '' &&
                   expirationDate.value !== '';
        }
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status ' + type;
            statusMessage.classList.remove('hidden');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }
        
        // Check if mobile device
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Export data as JSON
        function exportData() {
            const cardData = {
                driverId: driverId.value,
                driverName: driverName.value,
                companyName: companyName.value,
                expirationDate: expirationDate.value
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(cardData, null, 2));
            const link = document.createElement('a');
            link.download = `driver_card_${driverId.value || 'data'}.json`;
            link.href = dataStr;
            link.click();
        }
        
        // Print card (simple version)
        function printCard() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Driver ID Card - ${driverName.value}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .card { border: 2px solid #000; padding: 20px; max-width: 400px; margin: 0 auto; }
                        .card img { width: 100px; height: 120px; object-fit: cover; }
                    </style>
                </head>
                <body>
                    <div class="card">
                        <h2>Driver ID Card</h2>
                        ${currentPhotoData ? `<img src="${currentPhotoData}" alt="Driver Photo">` : ''}
                        <p><strong>ID:</strong> ${driverId.value}</p>
                        <p><strong>Name:</strong> ${driverName.value}</p>
                        <p><strong>Company:</strong> ${companyName.value}</p>
                        <p><strong>Expires:</strong> ${expirationDate.value}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }
        
        // Initialize
        loadSavedData();
        
        // Show welcome message
        setTimeout(() => {
            if (!localStorage.getItem('driverCard')) {
                showStatus('Fill in your driver information to create an ID card', 'info');
            }
        }, 1000);
    </script>
</body>
</html>
