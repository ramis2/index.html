<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPhone Compass - Ultimate Fix</title>
    <!-- iOS Specific Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Compass">
    <meta name="format-detection" content="telephone=no">
    <!-- Favicon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß≠</text></svg>">
    <style>
        /* RESET */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', 'Helvetica Neue', sans-serif;
            background: #000;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .container {
            max-width: 100%;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* HEADER */
        .header {
            text-align: center;
            padding: 20px 0;
            width: 100%;
        }
        
        .title {
            font-size: 36px;
            font-weight: 800;
            background: linear-gradient(90deg, #FF2D55, #5856D6, #34C759);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 14px;
            color: #8E8E93;
            font-weight: 400;
            letter-spacing: -0.15px;
        }
        
        /* IOS WARNING */
        .ios-alert {
            background: linear-gradient(135deg, #FF3B30, #FF9500);
            color: white;
            padding: 18px;
            border-radius: 14px;
            margin: 15px 0;
            text-align: center;
            width: 100%;
            display: none;
            animation: alertPulse 2s infinite;
            box-shadow: 0 6px 20px rgba(255, 59, 48, 0.3);
        }
        
        @keyframes alertPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.01); }
            100% { transform: scale(1); }
        }
        
        /* COMPASS */
        .compass-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 30px 0;
        }
        
        .compass-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px solid #5856D6;
            border-radius: 50%;
            opacity: 0.8;
        }
        
        .compass-inner {
            position: absolute;
            width: 90%;
            height: 90%;
            top: 5%;
            left: 5%;
            border: 1px solid rgba(88, 86, 214, 0.3);
            border-radius: 50%;
        }
        
        .compass-needle {
            position: absolute;
            width: 6px;
            height: 120px;
            top: 50%;
            left: 50%;
            transform-origin: 50% 100%;
            background: linear-gradient(to top, #FF2D55, #FF375F);
            border-radius: 3px;
            box-shadow: 0 0 20px rgba(255, 45, 85, 0.7);
            z-index: 10;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .compass-center {
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #FF2D55;
            border-radius: 50%;
            z-index: 20;
            box-shadow: 0 0 20px #FF2D55;
        }
        
        .direction-label {
            position: absolute;
            font-size: 32px;
            font-weight: 700;
        }
        
        .n-label { top: 15px; left: 50%; transform: translateX(-50%); color: #FF2D55; }
        .e-label { top: 50%; right: 20px; transform: translateY(-50%); color: #34C759; }
        .s-label { bottom: 15px; left: 50%; transform: translateX(-50%); color: #34C759; }
        .w-label { top: 50%; left: 20px; transform: translateY(-50%); color: #34C759; }
        
        /* INFO DISPLAY */
        .info-display {
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .degree-value {
            font-size: 56px;
            font-weight: 700;
            text-align: center;
            color: white;
            margin-bottom: 10px;
            font-feature-settings: "tnum";
            letter-spacing: -1px;
        }
        
        .direction-value {
            font-size: 42px;
            font-weight: 700;
            text-align: center;
            color: #FF2D55;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .direction-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 25px;
        }
        
        .direction-item {
            background: rgba(44, 44, 46, 0.9);
            border-radius: 12px;
            padding: 15px 5px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .direction-item.active {
            background: rgba(255, 45, 85, 0.2);
            border: 2px solid #FF2D55;
            transform: scale(1.05);
        }
        
        .direction-name {
            font-size: 11px;
            color: #8E8E93;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .direction-symbol {
            font-size: 28px;
            font-weight: 700;
        }
        
        /* CONTROLS */
        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            width: 100%;
        }
        
        .control-btn {
            flex: 1;
            padding: 22px 16px;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            -webkit-appearance: none;
        }
        
        .control-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        .btn-left { background: #007AFF; color: white; }
        .btn-right { background: #FF2D55; color: white; }
        .btn-fix { 
            background: linear-gradient(135deg, #FF9500, #FF5E3A);
            color: white;
            width: 100%;
            margin-bottom: 10px;
            display: none;
        }
        
        /* STATUS */
        .status-box {
            background: rgba(28, 28, 30, 0.9);
            border-radius: 14px;
            padding: 18px;
            margin: 15px 0;
            width: 100%;
            border-left: 5px solid #34C759;
        }
        
        .status-text {
            font-size: 15px;
            color: #8E8E93;
            text-align: center;
            line-height: 1.4;
        }
        
        .status-text.working { color: #34C759; }
        .status-text.error { color: #FF3B30; }
        
        /* INSTRUCTIONS */
        .instructions {
            background: rgba(28, 28, 30, 0.9);
            border-radius: 14px;
            padding: 20px;
            margin: 15px 0;
            width: 100%;
            display: none;
            border: 2px dashed #5856D6;
        }
        
        .instructions h3 {
            color: #FF9500;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .instructions ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            color: #C7C7CC;
        }
        
        /* FOOTER */
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: #8E8E93;
            font-size: 13px;
            line-height: 1.4;
            width: 100%;
        }
        
        /* RESPONSIVE */
        @media (max-width: 375px) {
            .compass-wrapper { width: 250px; height: 250px; }
            .degree-value { font-size: 48px; }
            .direction-value { font-size: 36px; }
            .control-btn { padding: 20px 14px; font-size: 16px; }
        }
        
        /* ANIMATIONS */
        @keyframes calibrate {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        .calibrating {
            animation: calibrate 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üß≠ iPhone Compass</h1>
            <p class="subtitle">By 0598 ‚Ä¢ Special iOS Version ‚Ä¢ Requires Safari</p>
        </div>
        
        <!-- iOS Alert -->
        <div class="ios-alert" id="iosAlert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>iPhone Users:</strong> Safari required for compass access
        </div>
        
        <!-- Instructions -->
        <div class="instructions" id="instructions">
            <h3>üì± iPhone Setup Instructions:</h3>
            <ol>
                <li><strong>Use Safari browser only</strong> (not Chrome/Firefox)</li>
                <li>Tap the <strong style="color:#FF9500">"ENABLE COMPASS"</strong> button below</li>
                <li>When iOS asks: <strong>Tap "Allow"</strong> for motion access</li>
                <li>Hold phone <strong>completely flat</strong> on a surface</li>
                <li>Slowly rotate phone 360¬∞ to calibrate</li>
            </ol>
            <p style="color:#8E8E93; font-size: 13px;">
                <i class="fas fa-info-circle"></i> iOS 13+ requires explicit permission for sensors
            </p>
        </div>
        
        <!-- Compass -->
        <div class="compass-wrapper">
            <div class="compass-outer"></div>
            <div class="compass-inner"></div>
            <div class="direction-label n-label">N</div>
            <div class="direction-label e-label">E</div>
            <div class="direction-label s-label">S</div>
            <div class="direction-label w-label">W</div>
            <div class="compass-needle" id="needle"></div>
            <div class="compass-center"></div>
        </div>
        
        <!-- Info Display -->
        <div class="info-display">
            <div class="degree-value" id="degrees">0¬∞</div>
            <div class="direction-value" id="direction">NORTH</div>
            
            <div class="direction-grid">
                <div class="direction-item active" data-dir="N">
                    <div class="direction-name">NORTH</div>
                    <div class="direction-symbol">N</div>
                </div>
                <div class="direction-item" data-dir="E">
                    <div class="direction-name">EAST</div>
                    <div class="direction-symbol">E</div>
                </div>
                <div class="direction-item" data-dir="S">
                    <div class="direction-name">SOUTH</div>
                    <div class="direction-symbol">S</div>
                </div>
                <div class="direction-item" data-dir="W">
                    <div class="direction-name">WEST</div>
                    <div class="direction-symbol">W</div>
                </div>
            </div>
        </div>
        
        <!-- Status -->
        <div class="status-box">
            <div class="status-text" id="status">
                <i class="fas fa-spinner fa-spin"></i> Initializing...
            </div>
        </div>
        
        <!-- Enable Button -->
        <button class="control-btn btn-fix" id="enableBtn">
            <i class="fas fa-compass"></i> ENABLE COMPASS
        </button>
        
        <!-- Controls -->
        <div class="controls">
            <button class="control-btn btn-left" id="rotateLeft">
                <i class="fas fa-arrow-left"></i> LEFT
            </button>
            <button class="control-btn btn-right" id="rotateRight">
                RIGHT <i class="fas fa-arrow-right"></i>
            </button>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Designed specifically for iPhones ‚Ä¢ iOS 13+ compatible</p>
            <p>Hold phone flat for accurate readings ‚Ä¢ Works offline once loaded</p>
        </div>
    </div>

    <script>
        // ===== ULTIMATE IPHONE COMPASS FIX =====
        
        // Elements
        const needle = document.getElementById('needle');
        const degrees = document.getElementById('degrees');
        const direction = document.getElementById('direction');
        const status = document.getElementById('status');
        const enableBtn = document.getElementById('enableBtn');
        const rotateLeftBtn = document.getElementById('rotateLeft');
        const rotateRightBtn = document.getElementById('rotateRight');
        const iosAlert = document.getElementById('iosAlert');
        const instructions = document.getElementById('instructions');
        const directionItems = document.querySelectorAll('.direction-item');
        
        // Variables
        let currentHeading = 0;
        let isIOS = false;
        let isSafari = false;
        let compassActive = false;
        let calibrationStep = 0;
        
        // Detect iOS & Safari
        function detectEnvironment() {
            const ua = navigator.userAgent;
            const isIPad = /Macintosh/.test(ua) && 'ontouchend' in document;
            
            isIOS = /iPad|iPhone|iPod/.test(ua) || isIPad;
            isSafari = /^((?!chrome|android).)*safari/i.test(ua);
            
            console.log("iOS:", isIOS, "Safari:", isSafari);
            
            if (isIOS) {
                iosAlert.style.display = 'block';
                instructions.style.display = 'block';
                enableBtn.style.display = 'flex';
                
                if (!isSafari) {
                    status.innerHTML = '<span class="error">‚ö†Ô∏è Switch to Safari browser for compass</span>';
                } else {
                    status.innerHTML = '<span>üì± iPhone Safari detected. Tap "ENABLE COMPASS"</span>';
                }
            } else {
                // Non-iOS devices
                autoStartCompass();
            }
        }
        
        // ===== MULTIPLE COMPASS METHODS FOR IOS =====
        
        // Method 1: Standard iOS Safari (webkitCompassHeading)
        function startIOSCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                
                status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Requesting iOS permission...';
                
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            status.innerHTML = '<span class="working">‚úÖ Permission granted! Calibrating...</span>';
                            compassActive = true;
                            
                            // Start listening
                            window.addEventListener('deviceorientation', handleIOSOrientation);
                            
                            // Show calibration
                            startCalibration();
                        } else {
                            status.innerHTML = '<span class="error">‚ùå Permission denied. Using simulation.</span>';
                            startSimulation();
                        }
                    })
                    .catch(error => {
                        console.error("iOS Permission error:", error);
                        status.innerHTML = '<span class="error">‚ö†Ô∏è Error: ' + error.message + '</span>';
                        tryMethod2();
                    });
            } else {
                tryMethod2();
            }
        }
        
        // Method 2: Try absolute orientation
        function tryMethod2() {
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Trying method 2...';
            
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleDeviceOrientation);
                compassActive = true;
                status.innerHTML = '<span class="working">‚úÖ Method 2 active. Calibrating...</span>';
                startCalibration();
            } else {
                tryMethod3();
            }
        }
        
        // Method 3: Try with timeout (some iPhones need delay)
        function tryMethod3() {
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Trying method 3...';
            
            setTimeout(() => {
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleDeviceOrientation);
                    compassActive = true;
                    status.innerHTML = '<span class="working">‚úÖ Method 3 active. Calibrating...</span>';
                    startCalibration();
                } else {
                    status.innerHTML = '<span class="error">‚ùå No compass support detected.</span>';
                    startSimulation();
                }
            }, 1000);
        }
        
        // Method 4: Try with user gesture event
        function tryMethod4() {
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Trying final method...';
            
            // Some iPhones need a user gesture event
            document.addEventListener('touchstart', function tryListen() {
                if (window.DeviceOrientationEvent) {
                    window.addEventListener('deviceorientation', handleDeviceOrientation);
                    compassActive = true;
                    status.innerHTML = '<span class="working">‚úÖ Method 4 active. Calibrating...</span>';
                    startCalibration();
                    document.removeEventListener('touchstart', tryListen);
                }
            }, { once: true });
            
            setTimeout(() => {
                if (!compassActive) {
                    status.innerHTML = '<span class="error">‚ùå Could not activate compass.</span>';
                    startSimulation();
                }
            }, 3000);
        }
        
        // ===== HANDLERS =====
        
        // iOS Safari handler
        function handleIOSOrientation(event) {
            if (event.webkitCompassHeading) {
                // iOS Safari with webkitCompassHeading
                currentHeading = 360 - event.webkitCompassHeading; // Convert to standard
                updateDisplay();
            } else if (event.alpha !== null) {
                // Fallback
                currentHeading = event.alpha;
                updateDisplay();
            }
        }
        
        // Standard device orientation handler
        function handleDeviceOrientation(event) {
            if (event.absolute === true && event.alpha !== null) {
                currentHeading = event.alpha;
                updateDisplay();
            } else if (event.alpha !== null) {
                currentHeading = event.alpha;
                updateDisplay();
            }
        }
        
        // ===== DISPLAY FUNCTIONS =====
        
        function updateDisplay() {
            // Normalize
            let heading = currentHeading % 360;
            if (heading < 0) heading += 360;
            
            // Update needle
            needle.style.transform = `translate(-50%, -100%) rotate(${heading}deg)`;
            
            // Update degrees
            degrees.textContent = Math.round(heading) + '¬∞';
            
            // Update direction
            const dir = getDirection(heading);
            direction.textContent = dir.name;
            direction.style.color = dir.color;
            
            // Update indicators
            updateIndicators(dir.symbol);
            
            // Update status if still calibrating
            if (calibrationStep > 0) {
                calibrationStep--;
                if (calibrationStep === 0) {
                    status.innerHTML = '<span class="working">‚úÖ Compass active & calibrated</span>';
                }
            }
        }
        
        function getDirection(heading) {
            const dirs = [
                {name: "NORTH", symbol: "N", min: 337.5, max: 22.5, color: "#FF2D55"},
                {name: "NORTHEAST", symbol: "NE", min: 22.5, max: 67.5, color: "#FF9500"},
                {name: "EAST", symbol: "E", min: 67.5, max: 112.5, color: "#34C759"},
                {name: "SOUTHEAST", symbol: "SE", min: 112.5, max: 157.5, color: "#5AC8FA"},
                {name: "SOUTH", symbol: "S", min: 157.5, max: 202.5, color: "#34C759"},
                {name: "SOUTHWEST", symbol: "SW", min: 202.5, max: 247.5, color: "#AF52DE"},
                {name: "WEST", symbol: "W", min: 247.5, max: 292.5, color: "#34C759"},
                {name: "NORTHWEST", symbol: "NW", min: 292.5, max: 337.5, color: "#FF2D55"}
            ];
            
            if (heading > 337.5 || heading < 22.5) return dirs[0];
            
            for (let dir of dirs) {
                if (heading >= dir.min && heading < dir.max) return dir;
            }
            
            return dirs[0];
        }
        
        function updateIndicators(symbol) {
            directionItems.forEach(item => {
                if (item.getAttribute('data-dir') === symbol) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // ===== CALIBRATION =====
        
        function startCalibration() {
            calibrationStep = 60; // 3 seconds at 20fps
            needle.classList.add('calibrating');
            
            setTimeout(() => {
                needle.classList.remove('calibrating');
            }, 3000);
        }
        
        // ===== SIMULATION (FALLBACK) =====
        
        function startSimulation() {
            status.innerHTML = '<span>üéÆ Simulation mode. Use buttons to rotate.</span>';
            compassActive = false;
            updateDisplay();
            
            rotateLeftBtn.disabled = false;
            rotateRightBtn.disabled = false;
        }
        
        function rotateLeft() {
            currentHeading = (currentHeading + 15) % 360;
            updateDisplay();
        }
        
        function rotateRight() {
            currentHeading = (currentHeading - 15 + 360) % 360;
            updateDisplay();
        }
        
        // ===== AUTO-START FOR NON-IOS =====
        
        function autoStartCompass() {
            if (window.DeviceOrientationEvent) {
                status.innerHTML = '<span class="working">‚úÖ Starting compass...</span>';
                window.addEventListener('deviceorientation', handleDeviceOrientation);
                compassActive = true;
                startCalibration();
            } else {
                status.innerHTML = '<span>üéÆ No compass detected. Using simulation.</span>';
                startSimulation();
            }
        }
        
        // ===== INITIALIZATION =====
        
        function init() {
            detectEnvironment();
            updateDisplay();
            
            // Event Listeners
            enableBtn.addEventListener('click', function() {
                if (isIOS) {
                    status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Activating...';
                    enableBtn.disabled = true;
                    enableBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ACTIVATING...';
                    
                    // Try all methods in sequence
                    startIOSCompass();
                    
                    setTimeout(() => {
                        if (!compassActive) tryMethod2();
                    }, 2000);
                    
                    setTimeout(() => {
                        if (!compassActive) tryMethod3();
                    }, 4000);
                    
                    setTimeout(() => {
                        if (!compassActive) tryMethod4();
                    }, 6000);
                }
            });
            
            rotateLeftBtn.addEventListener('click', rotateLeft);
            rotateRightBtn.addEventListener('click', rotateRight);
            
            // Touch feedback
            [rotateLeftBtn, rotateRightBtn, enableBtn].forEach(btn => {
                btn.addEventListener('touchstart', () => {
                    btn.style.opacity = '0.7';
                });
                btn.addEventListener('touchend', () => {
                    btn.style.opacity = '1';
                });
            });
        }
        
        // Start when page loads
        window.addEventListener('load', init);
        
        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && compassActive) {
                status.innerHTML = '<span class="working">üîÑ Reactivating compass...</span>';
                startCalibration();
            }
        });
    </script>
    
    <!-- Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>




